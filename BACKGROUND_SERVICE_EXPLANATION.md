# โ ุดุฑุญ ุนูู Service ูู ุงูุฎูููุฉ

## ๐ฏ ุงูุฅุฌุงุจุฉ ุนูู ุณุคุงูู:

**ูุนู! โ ุงูุชุทุจูู ุณูุนูู ุจุฏูู ูุดุงูู ููุนูู ูู ุงูุฎูููุฉ ููุฑุณู ุงูุชุญุฏูุซุงุช ููุณูุฑูุฑ ุญุชู ุนูุฏ ุฅุบูุงู ูุงูุฐุฉ ุงูุชุทุจูู.**

---

## ๐ง ููู ูุนูู ุงููุธุงู ุงูุขู:

### 1. **Foreground Service** (ุงูุฎุฏูุฉ ุงูุฃุณุงุณูุฉ)
- โ ูุนูู **ูุณุชููุงู ุชูุงูุงู** ุนู Flutter
- โ ูุฑุณู ุงูุจูุงูุงุช **ูุจุงุดุฑุฉ ููุณูุฑูุฑ** ุจุฏูู ุงูุงุนุชูุงุฏ ุนูู Flutter
- โ ูุนูู ุญุชู ุนูุฏ **ุฅุบูุงู ุงูุชุทุจูู ุจุงููุงูู**
- โ ูุธูุฑ ุฅุดุนุงุฑ ุฏุงุฆู ูููุณุชุฎุฏู

### 2. **ููู ูุชู ุงูุฅุฑุณุงู:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  LocationForegroundService (Kotlin)      โ
โ                                          โ
โ  1. ูุญุตู ุนูู ุงููููุน ูู GPS              โ
โ  2. ููุฑุฃ jobNumber ู apiKey ูู          โ
โ     SharedPreferences                    โ
โ  3. ูุฑุณู ูุจุงุดุฑุฉ ููุณูุฑูุฑ ุนุจุฑ HTTP        โ
โ     โ ุจุฏูู ุงูุงุนุชูุงุฏ ุนูู Flutter         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงูุณูุฑูุฑ                                 โ
โ  https://eissahr.replit.app/...         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 3. **WorkManager** (ุงุญุชูุงุทู)
- โ ูุนูู ูู 15 ุฏูููุฉ ูุญุฏ ุฃุฏูู
- โ ูุฑุณู ุงููููุน ุญุชู ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู
- โ ูุนูู ุญุชู ุนูุฏ ุฅุบูุงู ุงููุงุชู (ูู ูุถุน ุงูุณููู)

---

## ๐ฑ ุงูุณููุงุฑูููุงุช ุงููุฎุชููุฉ:

### โ ุงูุณููุงุฑูู 1: ุงูุชุทุจูู ููุชูุญ
- Service ูุนูู + Flutter ูุนูู
- ุงูุฅุฑุณุงู ูู Service ูุจุงุดุฑุฉ + ุชุญุฏูุซ UI ูู Flutter

### โ ุงูุณููุงุฑูู 2: ุงูุชุทุจูู ูู ุงูุฎูููุฉ
- Service ูุนูู + Flutter ูุชููู
- ุงูุฅุฑุณุงู ูู Service ูุจุงุดุฑุฉ โ

### โ ุงูุณููุงุฑูู 3: ุงูุชุทุจูู ูุบูู ุจุงููุงูู
- Service ูุนูู + Flutter ูุชููู ุชูุงูุงู
- ุงูุฅุฑุณุงู ูู Service ูุจุงุดุฑุฉ โ

### โ ุงูุณููุงุฑูู 4: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฌูุงุฒ
- BootReceiver ูุจุฏุฃ Service ุชููุงุฆูุงู
- Service ูุจุฏุฃ ุงูุฅุฑุณุงู ุชููุงุฆูุงู โ

---

## ๐ ุงูููุฏ ุงููุณุคูู ุนู ุงูุฅุฑุณุงู:

### ูู `LocationForegroundService.kt`:

```kotlin
// ุนูุฏ ุงูุญุตูู ุนูู ูููุน ุฌุฏูุฏ
locationCallback = object : LocationCallback() {
    override fun onLocationResult(locationResult: LocationResult) {
        locationResult.lastLocation?.let { location ->
            // 1. ุชุญุฏูุซ ุงูุฅุดุนุงุฑ
            updateNotificationWithLocation(location)
            
            // 2. ุฅุฑุณุงู ูุจุงุดุฑุฉ ููุณูุฑูุฑ (ูุนูู ุญุชู ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู)
            sendLocationToServer(location)  // โ ูุฐุง ูู ุงูููู!
            
            // 3. ุฅุฑุณุงู ุนุจุฑ Broadcast (ููุชุญุฏูุซ ูู Flutter ุฅุฐุง ูุงู ููุชูุญุงู)
            sendLocationBroadcast(location)
        }
    }
}
```

### ุฏุงูุฉ `sendLocationToServer`:

```kotlin
private fun sendLocationToServer(location: Location) {
    executor.execute {
        // 1. ูุฑุงุกุฉ jobNumber ู apiKey ูู SharedPreferences
        val prefs = getSharedPreferences("FlutterSharedPreferences", Context.MODE_PRIVATE)
        val jobNumber = prefs.getString("flutter.jobNumber", null)
        val apiKey = prefs.getString("flutter.apiKey", null) ?: API_KEY

        // 2. ุฅูุดุงุก JSON
        val jsonBody = """{
            "api_key": "$apiKey",
            "job_number": "$jobNumber",
            "latitude": ${location.latitude},
            "longitude": ${location.longitude},
            "accuracy": ${location.accuracy},
            "recorded_at": "$recordedAt"
        }"""

        // 3. ุฅุฑุณุงู HTTP request ูุจุงุดุฑุฉ
        sendHttpRequest(API_URL, jsonBody)
        
        // 4. ุฅุฐุง ูุดูุ ุฌุฑุจ ุงูุณูุฑูุฑ ุงูุจุฏูู
        if (!success) {
            sendHttpRequest(API_BACKUP_URL, jsonBody)
        }
    }
}
```

---

## โ ุงููููุฒุงุช:

1. **ูุณุชูู ุชูุงูุงู ุนู Flutter:**
   - Service ูุนูู ูู process ูููุตู
   - ูุง ูุญุชุงุฌ Flutter Engine
   - ูุนูู ุญุชู ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู

2. **ุฅุฑุณุงู ูุจุงุดุฑ:**
   - ูุณุชุฎุฏู `HttpURLConnection` ูุจุงุดุฑุฉ
   - ูุง ูุญุชุงุฌ ุฃู dependencies ุฅุถุงููุฉ
   - ูุนูู ูู thread ูููุตู

3. **ููุซูู:**
   - ูุญุงูู ุงูุณูุฑูุฑ ุงูุฃุณุงุณู ุฃููุงู
   - ุฅุฐุง ูุดูุ ูุญุงูู ุงูุณูุฑูุฑ ุงูุจุฏูู
   - ูุนูู ุญุชู ุนูุฏ ุงููุทุงุน ุงูุฅูุชุฑูุช (ูุญูุธ ูุญููุงู)

4. **ุขูู:**
   - ููุฑุฃ ุงูุจูุงูุงุช ูู SharedPreferences
   - ูุง ูุฎุฒู ุฃู ุจูุงูุงุช ุญุณุงุณุฉ
   - ูุณุชุฎุฏู HTTPS

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ:

### 1. ุงุฎุชุจุงุฑ ุงูุฅุฑุณุงู ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู:
```bash
# 1. ุงุจุฏุฃ ุงูุชุชุจุน ูู ุงูุชุทุจูู
# 2. ุฃุบูู ุงูุชุทุจูู ูู Recent Apps
# 3. ุชุญูู ูู logs:
adb logcat | grep LocationService

# ูุฌุจ ุฃู ุชุฑู:
# โ Location sent to server successfully
```

### 2. ุงุฎุชุจุงุฑ ุงูุฅุฑุณุงู ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู:
```bash
# 1. ุฃุนุฏ ุชุดุบูู ุงูุฌูุงุฒ
# 2. ุชุญูู ูู logs:
adb logcat | grep LocationService

# ูุฌุจ ุฃู ุชุฑู:
# Service started
# Location tracking started
# โ Location sent to server successfully
```

### 3. ุงูุชุญูู ูู ุงูุณูุฑูุฑ:
- ุงูุชุญ ููุญุฉ ุงูุชุญูู ูู ุงูุณูุฑูุฑ
- ุชุญูู ูู ุงุณุชูุจุงู ุงูุจูุงูุงุช ุญุชู ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ:

1. **ุงูุฃุฐููุงุช:**
   - ูุฌุจ ููุญ ุฃุฐููุงุช ุงููููุน (Foreground + Background)
   - ูุฌุจ ุงูููุงููุฉ ุนูู Battery Optimization exemption

2. **ุงูุฅุดุนุงุฑ:**
   - ุณูุธูุฑ ุฅุดุนุงุฑ ุฏุงุฆู "ุชุชุจุน ุงููููุน ูุดุท"
   - ูุฐุง ุถุฑูุฑู ูุนูู Service ูู ุงูุฎูููุฉ

3. **Battery Optimization:**
   - ุจุนุถ ุงูุดุฑูุงุช ุงููุตูุนุฉ (Xiaomi, Huawei) ูุฏููุง ูููุฏ ุฅุถุงููุฉ
   - ูุฏ ุชุญุชุงุฌ Auto-start permissions ุฎุงุตุฉ

---

## ๐ ุงูุฎูุงุตุฉ:

โ **ูุนูุ ุงูุชุทุจูู ุณูุนูู ุจุฏูู ูุดุงูู ููุนูู ูู ุงูุฎูููุฉ ููุฑุณู ุงูุชุญุฏูุซุงุช ููุณูุฑูุฑ ุญุชู ุนูุฏ ุฅุบูุงู ูุงูุฐุฉ ุงูุชุทุจูู.**

**ุงูุณุจุจ:**
- Service ูุนูู ูุณุชูู ุชูุงูุงู ุนู Flutter
- ูุฑุณู ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ููุณูุฑูุฑ
- ูุง ูุญุชุงุฌ Flutter Engine ููุนูู
- ูุนูู ุญุชู ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู ุจุงููุงูู

---

**ุชู ุงูุชุญุฏูุซ:** 2025-01-20  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู

