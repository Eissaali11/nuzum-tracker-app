# ๐ ุชูุฑูุฑ ูุดููุฉ: ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ - External Safety Check Issue

**ุงูุชุงุฑูุฎ:** 2025-01-XX  
**ุงููุธุงู:** Flutter Mobile App - Nuzum Tracker  
**ุงูุฎุงุฏู ุงููุชุฃุซุฑ:** `https://eissahr.replit.app` ู `https://nuzum.site`

---

## ๐ ููุฎุต ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุฅูุดุงุก ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ (External Safety Check) ูู ุงูุชุทุจููุ ูุนูุฏ ุฎุทุฃ **401 Unauthorized** ูุน ุฑุณุงูุฉ **"ุงูููุธู ุบูุฑ ููุฌูุฏ"** ูู ููุง ุงูุฎูุงุฏูุ ุฑุบู ุฃู ุงูุญุณุงุจ ูุดุท ููุณุฌู ูู ุงููุธุงู.

---

## ๐ ุชูุงุตูู ุงููุดููุฉ

### 1. ุงูู Endpoint ุงููุชุฃุซุฑ

```
POST /api/v1/external-safety/checks
```

### 2. ุงูุฎูุงุฏู ุงููุชุฃุซุฑุฉ

- โ `https://nuzum.site/api/v1/external-safety/checks` โ **401: ุงูููุธู ุบูุฑ ููุฌูุฏ**
- โ `https://eissahr.replit.app/api/v1/external-safety/checks` โ **401: ุงูููุธู ุบูุฑ ููุฌูุฏ**

### 3. ุงูุงุณุชุฌุงุจุฉ ูู ุงูุณุฑูุฑ

```json
{
  "success": false,
  "message": "ุงูููุธู ุบูุฑ ููุฌูุฏ"
}
```

**HTTP Status Code:** `401 Unauthorized`

---

## ๐ค ุงูุจูุงูุงุช ุงููุฑุณูุฉ

### Request Body:
```json
{
  "vehicle_id": 51,
  "driver_name": "EISSA ALI ABDOULLH MOHAMMED",
  "driver_national_id": "[ุฑูู ุงููููุฉ ุงููุทููุฉ]",
  "driver_department": "[ุงุณู ุงููุณู]",
  "driver_city": "[ุงุณู ุงููุฏููุฉ]",
  "current_delegate": "[ุงุณู ุงูููุฏูุจ ุงูุญุงูู]",
  "notes": "[ููุงุญุธุงุช ุงุฎุชูุงุฑูุฉ - ูุฏ ุชููู null]"
}
```

### Headers:
```
Authorization: Bearer [JWT_TOKEN]
Content-Type: application/json
```

### ููุงุญุธุงุช ูููุฉ:
- โ **Token ูุชู ุงูุญุตูู ุนููู ูู:** `POST /api/v1/auth/login`
- โ **Token ูุนูู ูุน ุฌููุน ุงูู endpoints ุงูุฃุฎุฑู**
- โ **Token ูุญุชูู ุนูู:** `employee_id` ู `national_id`
- โ **Token ูุง ูุนูู ูุน:** `/api/v1/external-safety/checks`

---

## ๐ ูุนูููุงุช ุงููุตุงุฏูุฉ

### Token Status:
- โ **Token ุตุญูุญ ูููุนู** - ูุนูู ูุน ุจุงูู ุงูู endpoints
- โ **Token ุบูุฑ ููุชูู ุงูุตูุงุญูุฉ**
- โ **Token ูุชู ุงูุชุญูู ููู ุจุดูู ุตุญูุญ**

### ุงูู Endpoints ุงูุชู ุชุนูู ูุน Token:
- โ `POST /api/v1/auth/login` โ **200 OK**
- โ `GET /api/v1/requests` โ **200 OK**
- โ `GET /api/v1/vehicles` โ **200 OK**
- โ `POST /api/external/employee-location` โ **200 OK**
- โ `GET /api/v1/notifications` โ **200 OK**

### ุงููุดููุฉ:
- โ `POST /api/v1/external-safety/checks` โ **401: ุงูููุธู ุบูุฑ ููุฌูุฏ**

### ุงูุชุญููู:
ุงูู Token ููุณู ุตุญูุญ ููุนููุ ููู ุงูู endpoint `/api/v1/external-safety/checks` ูุชุญูู ูู ูุฌูุฏ ุงูููุธู ูู ูุงุนุฏุฉ ุจูุงูุงุช ูููุตูุฉ (ูุธุงู ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ) ููุง ูุฌุฏู.

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช ุงูููุฌุฒุฉ

### 1. ุงุฎุชุจุงุฑ ุงููุตุงุฏูุฉ:
```
โ POST /api/v1/auth/login โ 200 OK
โ GET /api/v1/vehicles โ 200 OK
โ POST /api/external/employee-location โ 200 OK
โ POST /api/v1/external-safety/checks โ 401: ุงูููุธู ุบูุฑ ููุฌูุฏ
```

### 2. ุงุฎุชุจุงุฑ ุงููุณุงุฑุงุช ุงูุจุฏููุฉ:
```
โ POST /api/v1/external-safety/checks โ 401
โ POST /api/external-safety/checks โ 404
โ POST /api/v1/safety-checks โ 404
```

### 3. ุงุฎุชุจุงุฑ ุงูุฎูุงุฏู:
```
โ nuzum.site/api/v1/external-safety/checks โ 401: ุงูููุธู ุบูุฑ ููุฌูุฏ
โ eissahr.replit.app/api/v1/external-safety/checks โ 401: ุงูููุธู ุบูุฑ ููุฌูุฏ
```

---

## ๐ก ุงูุชุญููู ูุงููุฑุถูุงุช

### ุงููุฑุถูุฉ 1: ุงูููุธู ุบูุฑ ูุณุฌู ูู ูุธุงู ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ
**ุงูุงุญุชูุงู:** โญโญโญโญโญ (ุนุงูู ุฌุฏุงู)

**ุงูุณุจุจ ุงููุญุชูู:**
- ูุธุงู ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ ูุฏ ูููู ูููุตูุงู ุนู ูุธุงู ุงูููุธููู ุงูุฑุฆูุณู
- ูุฏ ูุญุชุงุฌ ุงูููุธู ุฅูู ุชุณุฌูู ูููุตู ูู ูุธุงู ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ
- ูุงุนุฏุฉ ุจูุงูุงุช ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ ูุฏ ุชููู ูููุตูุฉ

**ุงูุญู ุงูููุชุฑุญ:**
1. ุงูุชุญูู ูู ูุฌูุฏ ุงูููุธู ูู ุฌุฏูู `external_safety_employees` ุฃู ูุง ุดุงุจู
2. ุฅุถุงูุฉ ุงูููุธู ุฅูู ูุงุนุฏุฉ ุจูุงูุงุช ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ
3. ุฑุจุท ุงูููุธู ุจูู ุงููุธุงููู (ูุธุงู ุงูููุธููู ุงูุฑุฆูุณู ููุธุงู ูุญุต ุงูุณูุงูุฉ)

---

### ุงููุฑุถูุฉ 2: Token ุบูุฑ ุตุงูุญ ููุฐุง ุงูู Endpoint
**ุงูุงุญุชูุงู:** โญโญโญ (ูุชูุณุท)

**ุงูุณุจุจ ุงููุญุชูู:**
- ุงูู endpoint ูุฏ ูุชุทูุจ token ุฎุงุต ุฃู permissions ูุฎุชููุฉ
- ูุฏ ูููู ููุงู middleware ูุชุญูู ูู ูุฌูุฏ ุงูููุธู ูู ูุงุนุฏุฉ ุจูุงูุงุช ูููุตูุฉ

**ุงูุญู ุงูููุชุฑุญ:**
1. ุงูุชุญูู ูู middleware ุงูุฎุงุต ุจู `/api/v1/external-safety/checks`
2. ุงูุชุฃูุฏ ูู ุฃู Token ูุญุชูู ุนูู `employee_id` ุตุญูุญ
3. ุงูุชุญูู ูู permissions ุงููุทููุจุฉ ููุฐุง ุงูู endpoint

---

### ุงููุฑุถูุฉ 3: ูุงุนุฏุฉ ุจูุงูุงุช ูููุตูุฉ
**ุงูุงุญุชูุงู:** โญโญโญโญ (ุนุงูู)

**ุงูุณุจุจ ุงููุญุชูู:**
- ูุธุงู ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ ูุฏ ูุณุชุฎุฏู ูุงุนุฏุฉ ุจูุงูุงุช ูููุตูุฉ
- ุงูููุธู ูุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ ููู ุบูุฑ ูุณุฌู ูู ูุงุนุฏุฉ ุจูุงูุงุช ูุญุต ุงูุณูุงูุฉ

**ุงูุญู ุงูููุชุฑุญ:**
1. ุงูุชุญูู ูู ูุฌูุฏ ุงูููุธู ูู ูุงุนุฏุฉ ุจูุงูุงุช ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ
2. ุฅูุดุงุก ุณููู ุชููุงุฆู ุจูู ุงููุธุงููู
3. ุฅุถุงูุฉ ุงูููุธู ุฅูู ูุงุนุฏุฉ ุจูุงูุงุช ูุญุต ุงูุณูุงูุฉ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู

---

## ๐ง ุงูุญููู ุงูููุชุฑุญุฉ

### ุงูุญู 1: ุฅุถุงูุฉ ุงูููุธู ุฅูู ูุงุนุฏุฉ ุจูุงูุงุช ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ (ูุคูุช)
```sql
-- ูุซุงู (ูุฌุจ ุชุนุฏููู ุญุณุจ ุจููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช)
INSERT INTO external_safety_employees (employee_id, national_id, name, ...)
VALUES (?, ?, ?, ...);
```

### ุงูุญู 2: ุชุนุฏูู Middleware ููุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ (ุฏุงุฆู)
```javascript
// ูู middleware ุงูุฎุงุต ุจู /api/v1/external-safety/checks
// ุจุฏูุงู ูู ุงูุชุญูู ูู external_safety_employees ููุท
// ุชุญูู ูู employees ุงูุฑุฆูุณู ุฃูุถุงู
```

### ุงูุญู 3: ุฅูุดุงุก Endpoint ูุฑุจุท ุงูููุธููู (ูุณุชุญุณู)
```javascript
POST /api/v1/external-safety/sync-employee
// ูุฑุจุท ุงูููุธู ุจูู ุงููุธุงููู ุชููุงุฆูุงู
```

---

## ๐ Logs ูู ุงูุชุทุจูู

```
I/flutter: ๐ค [ExternalSafety] Creating safety check...
I/flutter:    Vehicle ID: 51
I/flutter:    Driver: EISSA ALI ABDOULLH MOHAMMED
I/flutter:    Endpoint: https://nuzum.site/api/v1/external-safety/checks
I/flutter: ๐ค [ExternalSafety] Trying: https://nuzum.site/api/v1/external-safety/checks
I/flutter: ๐ [APILog] Request logged: POST https://nuzum.site/api/v1/external-safety/checks
I/flutter: ๐ [APILog] Response logged: POST https://nuzum.site/api/v1/external-safety/checks - 401
I/flutter: ๐ค [ExternalSafety] Response status: 401
I/flutter: ๐ค [ExternalSafety] Response data: {message: ุงูููุธู ุบูุฑ ููุฌูุฏ, success: false}
I/flutter: โ [ExternalSafety] Employee not found in database (401): ุงูููุธู ุบูุฑ ููุฌูุฏ
```

---

## ๐ฏ ุงูุฎุทูุงุช ุงููุทููุจุฉ ูู REPLIT

### 1. ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- [ ] ุงูุชุญูู ูู ูุฌูุฏ ุงูููุธู ูู ุฌุฏูู ุงูููุธููู ุงูุฑุฆูุณู (`employees`)
- [ ] ุงูุชุญูู ูู ูุฌูุฏ ุงูููุธู ูู ุฌุฏูู ูุญุต ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ (`external_safety_employees` ุฃู ูุง ุดุงุจู)
- [ ] ุงูุชุญูู ูู ุฑุจุท ุงูููุธู ุจูู ุงููุธุงููู
- [ ] ุงูุชุญูู ูู ุฃู `employee_id` ูู Token ูุทุงุจู `employee_id` ูู ูุงุนุฏุฉ ุจูุงูุงุช ูุญุต ุงูุณูุงูุฉ

### 2. ุงูุชุญูู ูู Middleware/Controller:
- [ ] ูุฑุงุฌุนุฉ middleware ุงูุฎุงุต ุจู `/api/v1/external-safety/checks`
- [ ] ุงูุชุญูู ูู ุทุฑููุฉ ุงุณุชุฎุฑุงุฌ `employee_id` ูู Token
- [ ] ุงูุชุญูู ูู ุทุฑููุฉ ุงูุจุญุซ ุนู ุงูููุธู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุงูุชุฃูุฏ ูู ุฃู ุงูุจุญุซ ูุชู ูู ุงูุฌุฏูู ุงูุตุญูุญ

### 3. ุฅุตูุงุญ ุงููุดููุฉ (ุงุฎุชุฑ ุฃุญุฏ ุงูุญููู):

#### ุงูุญู 1: ุชุนุฏูู Middleware ููุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ
```javascript
// ุจุฏูุงู ูู:
const employee = await ExternalSafetyEmployee.findOne({ employee_id: token.employee_id });

// ุงุณุชุฎุฏู:
const employee = await Employee.findOne({ employee_id: token.employee_id });
// ุฃู
const employee = await Employee.findOne({ national_id: token.national_id });
```

#### ุงูุญู 2: ุฅูุดุงุก ุณููู ุชููุงุฆู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
```javascript
// ูู POST /api/v1/auth/login
// ุจุนุฏ ุงูุชุญูู ูู ุงูููุธูุ ุฃุถูู ุชููุงุฆูุงู ุฅูู external_safety_employees
await syncEmployeeToExternalSafety(employee);
```

#### ุงูุญู 3: ุฅูุดุงุก Endpoint ูุฑุจุท ุงูููุธููู
```javascript
POST /api/v1/external-safety/sync-employee
// ูุฑุจุท ุงูููุธู ุจูู ุงููุธุงููู ุชููุงุฆูุงู
```

#### ุงูุญู 4: ุชุนุฏูู ุงูุชุญูู ูููุจู ุงูููุธููู ูู ุงููุธุงู ุงูุฑุฆูุณู
```javascript
// ูู middleware:
const employee = await ExternalSafetyEmployee.findOne({ employee_id: token.employee_id })
  || await Employee.findOne({ employee_id: token.employee_id });
```

---

## ๐ ูุนูููุงุช ุฅุถุงููุฉ

### ูุนูููุงุช ุงูููุธู:
- **Employee ID:** [ูุชู ุฅุฑุณุงูู ูู Token]
- **National ID:** [ูุชู ุฅุฑุณุงูู ูู Request Body]
- **Name:** EISSA ALI ABDOULLH MOHAMMED

### ูุนูููุงุช ุงููุธุงู:
- **Flutter Version:** 3.35.3
- **App Version:** 1.0.0
- **Platform:** Android

---

## โ ุงูุญู ุงููุคูุช ุงููุทุจู ูู ุงูุชุทุจูู

ุชู ุชุทุจูู ุญู ูุคูุช ูู ุงูุชุทุจูู:
1. ูุญุงูู ุฑูุน ุงูุจูุงูุงุช ุนูู `nuzum.site` ุฃููุงู
2. ุฅุฐุง ูุดู (401 - ุงูููุธู ุบูุฑ ููุฌูุฏ)ุ ูุญุงูู ุนูู `eissahr.replit.app`
3. ุฅุฐุง ูุดู ุนูู ููุง ุงููุธุงูููุ ูุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ูููุณุชุฎุฏู

**ููู ูุฐุง ุงูุญู ูุคูุช ููุง ูุญู ุงููุดููุฉ ุงูุฌุฐุฑูุฉ.**

---

## ๐จ ุงูุฃููููุฉ

**ุนุงููุฉ ุฌุฏุงู** - ูุฐู ุงููุดููุฉ ุชููุน ุงููุณุชุฎุฏููู ูู ุฅูุดุงุก ูุญูุตุงุช ุงูุณูุงูุฉ ุงูุฎุงุฑุฌูุฉ.

---

## ๐ ุงูุชูุงุตู

ุฅุฐุง ูุงูุช ููุงู ุญุงุฌุฉ ููุนูููุงุช ุฅุถุงููุฉ ุฃู logs ุฃูุซุฑ ุชูุตููุงูุ ูุฑุฌู ุงูุชูุงุตู.

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-01-XX  
**ุงูุญุงูุฉ:** โณ ูู ุงูุชุธุงุฑ ุงูุญู ูู REPLIT

